<?xml version="1.0" encoding="UTF-8"?> 
<!--Setting locale for MEXICO-->
<#setting locale = "es_MX">
<!--Certification date-->
<#assign aDateTime = .now>
<!--Zeros number-->
<#assign zeros = "0.00">
<#assign customItem = customData.extraData.customItem>
<#assign customRecordData = customData.extraData.customRecordData>
<#function getAttrPair attr value1 value2>
   <#if value1?has_content>
    <#assign result="${attr}=\"${value1}\"">
    <#return result>
  <#else>
	<#assign result="${attr}=\"${value2}\"">
    <#return result>
  </#if>  
</#function>
<#function getAttrExist attr value>
	<#if value?has_content>
		<#assign result="${attr}=\"${value}\"">
		<#return result>
	</#if>  
</#function>
<#function getNodePair node attr value>
   <#if value?has_content>
    <#assign result="<${node} ${attr}=\"${value}\" />">
    <#return result>
  </#if>  
</#function>
<!--Transform a string from $0,0.00 to 0.00-->
<#function formatFromCurrency amount>
	<#assign result = amount?keep_after("$")?replace(",", "")?number?string[zeros]>
	<#return result>
</#function>
<#function formatFromString amount>
	<#assign result = amount?number?string[zeros]>
	<#return result>
</#function>
<#function formatRate amount>
	<#assign result = ((amount?number)/100)?string["0.000000"]>
	<#return result>
</#function>
<cfdi:Comprobante 
	xmlns:cfdi="http://www.sat.gob.mx/cfd/4" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="http://www.sat.gob.mx/cfd/4 http://www.sat.gob.mx/sitio_internet/cfd/4/cfdv40.xsd" 
	Version="4.0" 
	Fecha="${aDateTime?string.iso_nz?keep_before(".")}" 
	Serie="${customRecordData.serie}" 
	Folio="${customRecordData.folio}" 
	FormaPago="${record.custbody_ent_entloc_forma_pago?keep_before(" -")}" 
	SubTotal="${formatFromCurrency(record.subtotal)}" 
	Moneda="${record.currencysymbol}" 
	Total="${formatFromCurrency(record.total)}" 
	TipoDeComprobante="I" 
	MetodoPago="${record.custbody_ent_entloc_ent_metodo_pago?keep_before(" -")}" 
	LugarExpedicion="${customData.extraData.customSubsidiaryData.address.zip}" 
	Exportacion="${record.custbody_ent_entloc_exportacion?keep_before(" -")}" > 
	<#if customRecordData.relatedCfdis?has_content>
		<#list customRecordData.relatedCfdis as relatedCfdi>
			<cfdi:CfdiRelacionados TipoRelacion="${relatedCfdi.tipoRelacion?keep_before(" -")}">
				<#list relatedCfdi.transacciones as transaccion>
					<cfdi:CfdiRelacionado UUID="${transaccion.uuid}"/>
				</#list>
			</cfdi:CfdiRelacionados>
		</#list>
	</#if>
	<cfdi:Emisor 
		Rfc="${subsidiary.federalidnumber}" 
		Nombre="${subsidiary.name}" 
		RegimenFiscal="${subsidiary.custrecord_ent_entloc_regimen_fiscal?keep_before(" -")}"
	/> 
	<cfdi:Receptor 
		Rfc="${customer.custentity_ent_entloc_rfc}"
		Nombre="${customer.custentity_ent_entloc_nombre_legal_sat}" 
		DomicilioFiscalReceptor="${customer.billzip}" 
		RegimenFiscalReceptor="${record.custbody_ent_entloc_reg_fis_receptor?keep_before(" -")}" 
		UsoCFDI="${record.custbody_ent_entloc_uso_cfdi?keep_before(" -")}"
	/> 
	<cfdi:Conceptos>
		<#list record.item as item>
			<cfdi:Concepto 
				Cantidad="${item.quantity}" 
				Unidad="${item.units}" 
				NoIdentificacion="${item.item}" 
				Descripcion="${item.description}" 
				ValorUnitario="${formatFromCurrency(item.rate)}" 
				Importe="${formatFromCurrency(item.amount)}"
				${getAttrPair("ClaveProdServ", item.custcol_ent_entloc_sat_clv_pro_view?keep_before(" -"), item.custcol_ent_entloc_sat_clave_p_s_hidd?keep_before(" -"))}
				ClaveUnidad="${customItem.satUnitCodes[item?index]?keep_before(" -")}" 
				ObjetoImp="${item.custcol_ent_entloc_obj_impuesto?keep_before(" -")}"
			>
				<#if customItem.taxItemDetails?has_content>
					<cfdi:Impuestos> 
							<#if customItem.taxItemDetails[item?index].taxTrasDetails.isGroup?number == 0>
								<cfdi:Traslados> 
									<cfdi:Traslado 
										Base="${formatFromString(customItem.taxItemDetails[item?index].taxTrasDetails.base)}" 
										Impuesto="${customItem.taxItemDetails[item?index].taxTrasDetails.impuesto}" 
										TipoFactor="${customItem.taxItemDetails[item?index].taxTrasDetails.tipoFactor}" 
										TasaOCuota="${formatRate(customItem.taxItemDetails[item?index].taxTrasDetails.tasaOcuota)}" 
										Importe="${formatFromString(customItem.taxItemDetails[item?index].taxTrasDetails.importe)}"
									/> 
								</cfdi:Traslados>
							<#else>
								<cfdi:Traslados> 
									<#list customItem.taxItemDetails[item?index].taxTrasDetails.details as taxElement>
										<cfdi:Traslado 
											Base="${formatFromString(taxElement.base)}" 
											Impuesto="${taxElement.impuesto}" 
											TipoFactor="${taxElement.tipoFactor}" 
											TasaOCuota="${formatRate(taxElement.tasaOcuota)}" 
											Importe="${formatFromString(taxElement.importe)}"
										/> 
									</#list>
								</cfdi:Traslados>
							</#if>
							<#if customItem.taxItemDetails[item?index].taxRetDetails.isGroup?number == 0>
								<cfdi:Retenciones> 
									<cfdi:Retencion 
										Base="${formatFromString(customItem.taxItemDetails[item?index].taxRetDetails.base)}" 
										Impuesto="${customItem.taxItemDetails[item?index].taxRetDetails.impuesto}" 
										TipoFactor="${customItem.taxItemDetails[item?index].taxRetDetails.tipoFactor}" 
										TasaOCuota="${formatRate(customItem.taxItemDetails[item?index].taxRetDetails.tasaOcuota)}" 
										Importe="${formatFromString(customItem.taxItemDetails[item?index].taxRetDetails.importe)}"
									/> 
								</cfdi:Retenciones>
							<#else>
								<cfdi:Retenciones> 
									<#list customItem.taxItemDetails[item?index].taxRetDetails.details as taxElement>
										<cfdi:Retencion 
											Base="${formatFromString(taxElement.base)}" 
											Impuesto="${taxElement.impuesto}" 
											TipoFactor="${taxElement.tipoFactor}" 
											TasaOCuota="${formatRate(taxElement.tasaOcuota)}" 
											Importe="${formatFromString(taxElement.importe)}"
										/> 
									</#list>
								</cfdi:Retenciones>
							</#if>
					</cfdi:Impuestos> 
				</#if> 
			</cfdi:Concepto> 
		</#list> 
	</cfdi:Conceptos> 
	<#if customItem.taxTotal?has_content>
		<cfdi:Impuestos 
			${getAttrExist("TotalImpuestosTrasladados", formatFromString(customItem.taxTotal.totalTraslados))}
			${getAttrExist("TotalImpuestosRetenidos", formatFromString(customItem.taxTotal.totalRetenciones))}
		> 
			<#if customItem.taxSummary.summaryRet?has_content>
				<cfdi:Retenciones> 
					<#list customItem.taxSummary.summaryRet as elementSummary>
							<cfdi:Retencion 
								Importe="${formatFromString(elementSummary.importe)}" 
								Impuesto="${elementSummary.impuesto}" 
							/> 
					</#list>
				</cfdi:Retenciones> 
			</#if>	
			<#if customItem.taxSummary.summaryTras?has_content>
				<cfdi:Traslados> 
					<#list customItem.taxSummary.summaryTras as elementSummary>
							<cfdi:Traslado 
								Base="${formatFromString(elementSummary.base)}"
								Impuesto="${elementSummary.impuesto}" 
								TipoFactor="${elementSummary.tipoFactor}"
								TasaOCuota="${formatRate(elementSummary.tasaOcuota)}" 
								Importe="${formatFromString(elementSummary.importe)}" 
							/> 
					</#list>
				</cfdi:Traslados> 
			</#if>
		</cfdi:Impuestos> 
	</#if>
</cfdi:Comprobante>